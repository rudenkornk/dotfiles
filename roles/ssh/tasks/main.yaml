- name: Install ssh tools
  become: true
  ansible.builtin.package:
    name:
      - "{{ {'Ubuntu': 'libssl-dev', 'Fedora': 'openssl-devel'}[ansible_distribution] }}"
      - "{{ {'Ubuntu': 'openssh-client', 'Fedora': 'openssh'}[ansible_distribution] }}"
      - openssh-server
      - sshpass

- name: Enable public key authentication
  become: true
  ansible.builtin.lineinfile:
    path: "/etc/ssh/sshd_config"
    regexp: '[ #]{0,10}PubkeyAuthentication \w*\s*$'
    line: PubkeyAuthentication yes

- name: Disable password authentication
  become: true
  ansible.builtin.lineinfile:
    path: "/etc/ssh/sshd_config"
    regexp: '[ #]{0,10}PasswordAuthentication \w*\s*$'
    line: PasswordAuthentication no

- name: Disable keyboard interactive authentication
  become: true
  ansible.builtin.lineinfile:
    path: "/etc/ssh/sshd_config"
    regexp: '[ #]{0,10}KbdInteractiveAuthentication \w*\s*$'
    line: KbdInteractiveAuthentication no

- name: Disable challenge response authentication
  become: true
  ansible.builtin.lineinfile:
    path: "/etc/ssh/sshd_config"
    regexp: '[ #]{0,10}ChallengeResponseAuthentication \w*\s*$'
    line: ChallengeResponseAuthentication no

- name: Disable challenge response authentication
  become: true
  ansible.builtin.lineinfile:
    path: "/etc/ssh/sshd_config"
    regexp: '[ #]{0,10}UsePAM \w*\s*$'
    line: UsePAM no

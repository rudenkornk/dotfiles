name: Workflow

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main

defaults:
  run:
    shell: bash

jobs:

  config:
    runs-on: ubuntu-22.04
    steps:
    - name: Checkout repository
      uses: actions/checkout@v3
    - name: Config
      run: make
    - name: Check idempotence
      run: |
        make | tee __build__/log
        ! (grep -oP "changed=\d+" __build__/log | grep -oPq "changed=[1-9]")

  check:
    strategy:
      matrix:
        ubuntu_tag: ["22.04", "22.10"]
    runs-on: ubuntu-22.04
    env:
      UBUNTU_TAG: ${{ matrix.ubuntu_tag }}
      USER: random_user
    steps:
    - name: Checkout repository
      uses: actions/checkout@v3
    - name: Check bootstrap control node
      run: make check_bootstrap_control_node
    - name: Check config
      run: make check
    - name: Check idempotence
      run: |
        make check | tee __build__/log
        ! (grep -oP "changed=\d+" __build__/log | grep -oPq "changed=[1-9]")

  lint:
    runs-on: ubuntu-22.04
    steps:
    - name: Checkout repository
      uses: actions/checkout@v3
    - name: Lint
      run: make lint

  scripts:
    runs-on: ubuntu-22.04
    steps:
    - name: Checkout repository
      uses: actions/checkout@v3
    - name: Check update works
      run: make update
    - name: Show diff
      run: git diff
    - name: Generate roles graph
      run: make graph

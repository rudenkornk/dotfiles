- name: Configure control node
  hosts: localhost
  tasks:
  - name: Load ansible collections versions
    ansible.builtin.include_vars:
      file: roles/ansible/vars/main.yaml

  - name: Install community.general
    ansible.builtin.command: "ansible-galaxy collection install community.general:{{ community_general.version }}"
    changed_when: '"Nothing to do" not in collection_installed.stdout'
    delay: 300
    register: collection_installed
    retries: 10
    until: collection_installed is not failed

  - name: Install ansible.posix
    ansible.builtin.command: "ansible-galaxy collection install ansible.posix:{{ ansible_posix.version }}"
    changed_when: '"Nothing to do" not in collection_installed.stdout'
    delay: 300
    register: collection_installed
    retries: 10
    until: collection_installed is not failed

  - name: Install containers.podman
    ansible.builtin.command: "ansible-galaxy collection install containers.podman:{{ containers_podman.version }}"
    changed_when: '"Nothing to do" not in collection_installed.stdout'
    delay: 300
    register: collection_installed
    retries: 10
    until: collection_installed is not failed

  - name: Install rsync (for ansible synchronize tasks)
    become: true
    ansible.builtin.apt:
      name: rsync

  - name: Install podman (for checking config in containers)
    become: true
    ansible.builtin.apt:
      name: podman

  - name: Install git (for support.py update)
    become: true
    ansible.builtin.apt:
      name: git

  - name: Install graphviz (for support.py graph)
    become: true
    ansible.builtin.apt:
      name: graphviz
